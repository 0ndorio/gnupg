#!/bin/sh
# Make a snapshot of the CVS head revision for the gnupg webpages

set -e

myhome="$HOME/pub"
pgm="gnupg-www"
mod="gnupg-www"
MKWEBSITE=$HOME/bin/mkwebsite


cd $myhome

rm -rf $pgm.tmp 2>/dev/null || true
rm -rf $pgm.new || true
mkdir  $pgm.new || true
rm -rf $pgm.old || true
cvs -Q export -r HEAD -d $pgm.tmp $mod
cat <<EOF >$pgm.tmp/en/NEWS
[ This is a snapshot of the NEWS file from the CVS head revision.
  You will find the NEWS for the latest revision below the line
  "Noteworthy changes in version 1.x.y".
						     (wk $(date +%Y-%m-%d)) ]


EOF
cvs -Q checkout -p gnupg/NEWS >>$pgm.tmp/en/NEWS
cvs -Q checkout -p gnupg/BUGS | sed  '1,/^~~~~~~~~~~~/ d' > $pgm.tmp/en/include-file-1.tmp
echo "(List generated from CVS: " $(date +%Y-%m-%d) ")"  >> $pgm.tmp/en/include-file-1.tmp
cd $pgm.tmp
$MKWEBSITE --cvs --use-this-dir $myhome/$pgm.new
cd $myhome
rm -rf $pgm.tmp || true

rm -rf $pgm.old || true
[ -d $pgm ] && mv $pgm $pgm.old
if ! mv $pgm.new $pgm ; then
    echo "rename failed - restoring" >&2
    mv $pgm.old $pgm
    exit 1
fi
rm -rf $pgm.old || true

